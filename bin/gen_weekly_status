#!/bin/bash
FILENAME=weekly_status.txt;
git standup -f > /dev/null 2>&1  # Fetch all repos to get most recent commits
git standup -r -s -d 7 >> /dev/null 2>&1; # Generate the report
mv git-standup-report.txt $FILENAME # Rename the report

# Remove the Unnecessary info from the report
if [ "$(uname)" = "Linux" ]; then
  sed -i -e 's/^.*-/-/' -e 's/ (.*ago) <.*>//' $FILENAME
elif [ "$(uname)" = "Darwin" ]; then
  sed -i '' -e 's/^.*-/-/' -e 's/ (.*ago) <.*>//' -e 's:.*/::' $FILENAME
fi

# SSH command to get IRI extracts that failed after the first try
ssh grouper; psql -c "" customer >> $FILENAME

# SSH command to get Neilsen extracts that failed after the first try
ssh grouper; psql -c "SELECT DISTINCT ON(code) code, was_extracted, was_delivered, timestamp
  FROM customer JOIN customer_extracts_log cel ON(id=vision_customer_id)
  WHERE extract_type ~ 'nielsen' AND timestamp > now() - '1 month'::interval
  ORDER BY code, timestamp desc, code;" customer >> $FILENAME

# Get list of Failed Jobs that where reviewed from Docupiler
ssh grouper; ssh root@docupiler.com; sudo su - postgres; psql -c "SELECT COUNT(*) FROM vpdf_jobs WHERE last_error IS NOT NULL AND reviewed_on IS NOT NULL" vpdf_production >> $FILENAME

cat $FILENAME
